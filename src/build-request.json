{
  "kind": "build_request",
  "title": "Implement split payment system with dual Stripe configuration options",
  "projectName": "Artisan Hub Marketplace",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-37",
      "text": "Add a stripeApiKey optional field of type ?Text to the UserProfile data model in backend/main.mo to store artists' Stripe secret keys for direct payment configuration",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-stripe-key-setup"
        ],
        "quotes": [
          "provide stripe key in settings or use of stripe connect, allow both options"
        ]
      },
      "acceptanceCriteria": [
        "UserProfile type includes optional stripeApiKey field",
        "Existing artist profiles are not affected by schema addition",
        "Field is securely stored and only accessible to the profile owner and admin"
      ]
    },
    {
      "id": "REQ-38",
      "text": "Add payment configuration section to the ArtistDashboard page in frontend/src/pages/ArtistDashboard.tsx with a form allowing artists to either provide a Stripe API key directly or use Stripe Connect onboarding",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-stripe-key-setup"
        ],
        "quotes": [
          "create a stripe key setup in artist dashboard",
          "provide stripe key in settings or use of stripe connect, allow both options"
        ]
      },
      "acceptanceCriteria": [
        "Payment configuration section is visible in artist dashboard",
        "Form displays current payment method status (Stripe Connect or API key)",
        "Artists can input and save Stripe API key",
        "Artists can initiate Stripe Connect onboarding flow",
        "Clear indication of which payment method is currently active",
        "Validation that at least one payment method is configured before artists can receive payments"
      ]
    },
    {
      "id": "REQ-39",
      "text": "Add adminStripeAccountId field of type ?Text to backend storage in backend/main.mo to store the platform admin's Stripe account identifier for receiving commission payments",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-stripe-key-setup"
        ],
        "quotes": [
          "in existing admin dashboard"
        ]
      },
      "acceptanceCriteria": [
        "Backend storage includes adminStripeAccountId field",
        "Field can be set and retrieved via backend function",
        "Only users with admin role can access or modify this field"
      ]
    },
    {
      "id": "REQ-40",
      "text": "Add Stripe account configuration form to the AdminDashboard page in frontend/src/pages/AdminDashboard.tsx where platform admin can input and save their Stripe account ID to receive commission payments",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-stripe-key-setup"
        ],
        "quotes": [
          "in existing admin dashboard",
          "platform admin can configure their payment details to receive the commission"
        ]
      },
      "acceptanceCriteria": [
        "Admin Stripe configuration form is visible on AdminDashboard",
        "Form displays current admin Stripe account ID if configured",
        "Admin can input and update Stripe account ID",
        "Form validation ensures valid account ID format",
        "Success/error messages displayed on save"
      ]
    },
    {
      "id": "REQ-41",
      "text": "Implement backend function in backend/main.mo named processSplitPayment that calculates the commission split based on the configured commission rate, and coordinates payment distribution to both admin and artist Stripe accounts",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-stripe-key-setup"
        ],
        "quotes": [
          "when a purchase is actioned, the admin comision is executed and a split payment sent to platform admin and to user that made the sale"
        ]
      },
      "acceptanceCriteria": [
        "Function accepts product ID, purchase amount, and buyer information as parameters",
        "Function retrieves current commission rate from storage",
        "Function calculates admin commission and artist share based on commission rate",
        "Function identifies artist's payment method (Stripe Connect account ID or API key)",
        "Function identifies admin's Stripe account ID",
        "Function returns success/failure status with transaction details",
        "Function handles errors when payment configuration is missing for admin or artist"
      ]
    },
    {
      "id": "REQ-42",
      "text": "Update the BuyNowButton component in frontend/src/components/BuyNowButton.tsx to trigger the processSplitPayment backend function after successful Stripe checkout completion, ensuring automatic payment distribution occurs",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-stripe-key-setup"
        ],
        "quotes": [
          "when a purchase is actioned, the admin comision is executed and a split payment sent to platform admin and to user that made the sale"
        ]
      },
      "acceptanceCriteria": [
        "After successful Stripe checkout, split payment function is called",
        "Loading state displayed during split payment processing",
        "Success message shown when split payment completes successfully",
        "Error handling and user feedback when split payment fails",
        "Payment success page reflects that payment has been distributed"
      ]
    },
    {
      "id": "REQ-43",
      "text": "Add validation to the product checkout flow that prevents purchase if either the artist or admin has not configured their Stripe payment details, displaying a clear error message to the buyer",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-user-stripe-key-setup"
        ],
        "quotes": [
          "when a purchase is actioned, the admin comision is executed and a split payment sent to platform admin and to user that made the sale"
        ]
      },
      "acceptanceCriteria": [
        "Backend validates that artist has either Stripe Connect account or API key configured",
        "Backend validates that admin has Stripe account ID configured",
        "Checkout is blocked if payment configuration is incomplete",
        "Clear error message displayed to buyer explaining the issue",
        "Product card or buy button indicates when payment configuration is incomplete"
      ]
    }
  ],
  "constraints": [
    "Do not modify the existing Stripe Connect onboarding implementation - extend it to support dual payment options",
    "Maintain single-actor architecture in backend/main.mo",
    "Do not modify immutable frontend paths: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui",
    "Preserve existing commission rate configuration in CommissionSettings component",
    "Ensure split payment logic respects the dynamically configured commission rate from admin settings"
  ],
  "nonGoals": [
    "Implementing actual Stripe API payment processing (focus on data model and UI flow)",
    "Modifying the existing revenue analytics dashboard",
    "Changing the existing checkout session creation logic beyond adding split payment trigger",
    "Adding payment history or transaction logs",
    "Implementing refund or dispute handling"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}